@if (loading()) {
  <div class="loading-container">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading checkout...</p>
    </div>
  </div>
} @else if (!order()) {
  <div class="error-container">
    <div class="error-content">
      <span class="material-symbols-outlined">error</span>
      <p>Order not found</p>
      <button (click)="goBack()" class="back-link">Go back to menu</button>
    </div>
  </div>
} @else {
  <div class="checkout-container">
    <!-- Header -->
    <header class="checkout-header">
      <button (click)="goBack()" class="back-button">
        <span class="material-symbols-outlined">arrow_back</span>
      </button>
      <h1 class="header-title">Checkout</h1>
    </header>

    <main class="checkout-main">
      <div class="page-header">
        <h2 class="page-title">Review Your Order</h2>
        <p class="page-subtitle">Verify details before payment</p>
      </div>

      @if (error()) {
        <div class="error-alert">
          <span class="material-symbols-outlined">error</span>
          <span>{{ error() }}</span>
        </div>
      }

      <div class="checkout-grid">
        <!-- Left Column -->
        <div class="checkout-left">
          
          <!-- Customer Details Card -->
          <div class="detail-card">
            <div class="card-header">
              <div class="header-left">
                <span class="material-symbols-outlined icon">person</span>
                <h3>Customer Details</h3>
              </div>
              @if (!editingDetails()) {
                <button (click)="editingDetails.set(true)" class="edit-button">
                  <span class="material-symbols-outlined">edit</span>
                  Edit
                </button>
              }
            </div>

            @if (editingDetails()) {
              <div class="edit-form">
                <div class="form-field">
                  <label>Name</label>
                  <input
                    [(ngModel)]="customerName"
                    placeholder="Enter name"
                    class="input-field"
                  />
                </div>
                <div class="form-actions">
                  <button (click)="saveDetails()" class="btn-primary">Save</button>
                  <button (click)="editingDetails.set(false)" class="btn-secondary">Cancel</button>
                </div>
              </div>
            } @else {
              <div class="detail-grid">
                <div class="detail-item">
                  <p class="detail-label">Name</p>
                  <p class="detail-value">{{ customerName || 'Not provided' }}</p>
                </div>
                <div class="detail-item">
                  <p class="detail-label">Phone</p>
                  <p class="detail-value">{{ customerPhone || 'Not provided' }}</p>
                </div>
              </div>
            }
          </div>

          <!-- Delivery Address Card -->
          <div class="detail-card">
            <div class="card-header">
              <div class="header-left">
                <span class="material-symbols-outlined icon">location_on</span>
                <h3>Delivery Address</h3>
              </div>
              @if (!editingAddress()) {
                <button (click)="editingAddress.set(true)" class="edit-button">
                  <span class="material-symbols-outlined">edit</span>
                  Edit
                </button>
              }
            </div>

            @if (editingAddress()) {
              <div class="edit-form">
                <textarea
                  [(ngModel)]="deliveryAddress"
                  rows="3"
                  placeholder="Enter delivery address"
                  class="textarea-field"
                ></textarea>
                <div class="form-actions">
                  <button (click)="saveAddress()" class="btn-primary">Save</button>
                  <button (click)="editingAddress.set(false)" class="btn-secondary">Cancel</button>
                </div>
              </div>
            } @else {
              <div class="address-content">
                <p>{{ deliveryAddress || 'Address not provided' }}</p>
              </div>
            }
          </div>

          <!-- Security Badge -->
          <div class="security-badge">
            <span class="material-symbols-outlined">lock</span>
            <span>Secure checkout powered by Stripe</span>
          </div>
        </div>

        <!-- Right Column -->
        <div class="checkout-right">
          <div class="order-summary-card">
            <div class="summary-header">
              <span class="material-symbols-outlined">receipt_long</span>
              <h3>Order Summary</h3>
            </div>

            <div class="summary-content">
              @if (cartItems().length === 0) {
                <div class="empty-cart">
                  <span class="material-symbols-outlined">shopping_cart</span>
                  <p>Your cart is empty</p>
                </div>
              } @else {
                <div class="items-list">
                  @for (item of cartItems(); track item._id) {
                    <div class="cart-item">
                      <div class="item-info">
                        <span class="item-name">{{ item.productName }}</span>
                        <p class="item-quantity">Quantity: {{ item.quantity }}</p>
                        @if (item.selectedAddons.length > 0) {
                          <p class="item-addons">{{ getAddonNames(item.selectedAddons) }}</p>
                        }
                      </div>
                      <span class="item-price">₹{{ item.itemTotal }}</span>
                    </div>
                  }
                </div>

                <hr class="divider">

                <div class="fee-row">
                  <span>Delivery Fee</span>
                  <span class="strikethrough">₹40</span>
                </div>
                <div class="fee-row">
                  <span>Taxes & Charges</span>
                  <span>₹0</span>
                </div>

                <hr class="divider">

                <div class="total-section">
                  <span class="total-label">Total Amount</span>
                  <div class="total-right">
                    <span class="total-amount">₹{{ cartTotal() }}</span>
                    <p class="tax-note">Inclusive of all taxes</p>
                  </div>
                </div>

                <button 
                  (click)="proceedToPayment()"
                  [disabled]="processingPayment()"
                  class="checkout-button"
                >
                  @if (processingPayment()) {
                    <span class="material-symbols-outlined spinner">progress_activity</span>
                    <span>Processing...</span>
                  } @else {
                    <span>Proceed to Payment</span>
                    <span class="material-symbols-outlined">arrow_forward</span>
                  }
                </button>

                <p class="terms-text">
                  By proceeding, you agree to our Terms of Service and Privacy Policy.
                </p>
              }
            </div>
          </div>

          <!-- Trust Badges -->
          <div class="trust-badges">
            <span class="material-symbols-outlined">verified_user</span>
            <span class="material-symbols-outlined">payment</span>
            <span class="material-symbols-outlined">credit_card</span>
            <span class="material-symbols-outlined">shield</span>
          </div>
        </div>
      </div>
    </main>
  </div>
}