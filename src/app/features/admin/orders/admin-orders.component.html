<div class="flex flex-col flex-1 min-h-0 bg-gray-50">

  <!-- Header -->
  <div class="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between shrink-0">
    <div>
      <h1 class="text-xl font-semibold text-gray-900">Orders</h1>
      <p class="text-sm text-gray-500 mt-0.5">{{ filteredOrders().length }} order{{ filteredOrders().length !== 1 ? 's' : '' }}</p>
    </div>
    <div class="flex items-center gap-2">
      <!-- Live indicator -->
      <div class="flex items-center gap-1.5 text-xs text-gray-400 mr-1">
        <span class="relative flex h-2 w-2">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
        </span>
        Socket Live
      </div>
      <!-- Export CSV -->
      <button (click)="exportCSV()"
        class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
        <span class="material-symbols-outlined text-[18px]">download</span>
        Export CSV
      </button>
      <!-- Refresh -->
      <button (click)="loadOrders()"
        class="flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
        <span class="material-symbols-outlined text-[18px]">refresh</span>
        Refresh
      </button>
    </div>
  </div>

  <!-- Filters row -->
  <div class="bg-white border-b border-gray-200 px-6 shrink-0">
    <!-- Status tabs -->
    <div class="flex gap-1 border-b border-gray-100 -mb-px">
      @for (tab of statusTabs; track tab.value) {
        <button (click)="setStatusFilter(tab.value)"
          class="px-4 py-3 text-sm font-medium border-b-2 transition-colors whitespace-nowrap"
          [class]="statusFilter() === tab.value
            ? 'border-[#0a2e1a] text-[#0a2e1a]'
            : 'border-transparent text-gray-500 hover:text-gray-700'">
          {{ tab.label }}
        </button>
      }
    </div>

    <!-- Search -->
    <div class="py-3">
      <div class="relative max-w-sm">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[18px]">search</span>
        <input type="text" placeholder="Search by order #, phone, name…"
          [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)"
          class="w-full pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#0a2e1a]/20 focus:border-[#0a2e1a]" />
      </div>
    </div>
  </div>

  <!-- Table area -->
  <div class="flex-1 overflow-auto">
    @if (loading()) {
      <div class="flex items-center justify-center h-48 text-gray-400">
        <span class="material-symbols-outlined animate-spin text-3xl">progress_activity</span>
      </div>
    } @else if (filteredOrders().length === 0) {
      <div class="flex flex-col items-center justify-center h-48 text-gray-400 gap-2">
        <span class="material-symbols-outlined text-4xl">receipt_long</span>
        <p class="text-sm">No orders found</p>
      </div>
    } @else {
      <table class="w-full text-sm">
        <thead class="bg-gray-50 border-b border-gray-200 sticky top-0 z-10">
          <tr>
            <th class="text-left px-6 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Order</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Customer</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Phone</th>
            <th class="text-right px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Items</th>
            <th class="text-right px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Total</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Status</th>
            <th class="text-left px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wide">Date</th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          @for (order of filteredOrders(); track order._id) {
            <!-- Main row -->
            <tr (click)="toggleExpand(order._id)"
              class="bg-white hover:bg-gray-50 cursor-pointer transition-colors"
              [class.bg-blue-50]="expandedOrderId() === order._id">
              <td class="px-6 py-4 font-mono font-medium text-gray-900">{{ order.orderNumber }}</td>
              <td class="px-4 py-4 text-gray-700">{{ order.customerName || '—' }}</td>
              <td class="px-4 py-4 text-gray-500 font-mono">{{ order.phoneNumber }}</td>
              <td class="px-4 py-4 text-right text-gray-600">{{ order.items.length }}</td>
              <td class="px-4 py-4 text-right font-medium text-gray-900">{{ formatCurrency(order.total) }}</td>
              <td class="px-4 py-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ statusBadgeClass(order.status) }}">
                  {{ statusLabel(order.status) }}
                </span>
              </td>
              <td class="px-4 py-4 text-gray-400 text-xs whitespace-nowrap">{{ formatDate(order.createdAt) }}</td>
              <td class="px-4 py-4 text-gray-400">
                <span class="material-symbols-outlined text-[18px] transition-transform"
                  [class.rotate-180]="expandedOrderId() === order._id">
                  expand_more
                </span>
              </td>
            </tr>

            <!-- Expanded detail row -->
            @if (expandedOrderId() === order._id) {
              <tr class="bg-blue-50/50">
                <td colspan="8" class="px-6 pb-5 pt-0">
                  <div class="border border-blue-100 rounded-xl bg-white p-5 shadow-sm">
                    <div class="flex gap-6 flex-wrap">

                      <!-- Items list -->
                      <div class="flex-1 min-w-60">
                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Items</p>
                        <div class="space-y-2">
                          @for (item of order.items; track item._id) {
                            <div class="flex justify-between items-start gap-4">
                              <div>
                                <p class="text-sm font-medium text-gray-800">{{ item.productName }} × {{ item.quantity }}</p>
                                @if (item.selectedAddons.length > 0) {
                                  <p class="text-xs text-gray-400 mt-0.5">
                                    {{ item.selectedAddons.map(a => a.addonName).join(', ') }}
                                  </p>
                                }
                              </div>
                              <p class="text-sm text-gray-700 whitespace-nowrap">{{ formatCurrency(item.itemTotal) }}</p>
                            </div>
                          }
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between">
                          <span class="text-sm font-semibold text-gray-800">Total</span>
                          <span class="text-sm font-semibold text-gray-900">{{ formatCurrency(order.total) }}</span>
                        </div>
                      </div>

                      <!-- Divider -->
                      <div class="w-px bg-gray-100 self-stretch hidden md:block"></div>

                      <!-- Order details + status change -->
                      <div class="min-w-52">
                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Details</p>
                        <div class="space-y-2 text-sm">
                          <div class="flex gap-2">
                            <span class="text-gray-400 w-20 shrink-0">Order #</span>
                            <span class="font-mono text-gray-700">{{ order.orderNumber }}</span>
                          </div>
                          <div class="flex gap-2">
                            <span class="text-gray-400 w-20 shrink-0">Type</span>
                            <span class="text-gray-700">{{ order.isAssistedOrder ? 'Assisted' : 'Self-service' }}</span>
                          </div>
                          @if (order.deliveryAddress?.text) {
                            <div class="flex gap-2">
                              <span class="text-gray-400 w-20 shrink-0">Address</span>
                              <span class="text-gray-700">{{ order.deliveryAddress!.text }}</span>
                            </div>
                          }
                        </div>

                        <!-- Print Ticket -->
                        <div class="mt-4">
                          <button (click)="printOrder(order, $event)"
                            class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium border border-gray-200 text-gray-500 hover:border-gray-400 hover:text-gray-700 transition-all">
                            <span class="material-symbols-outlined text-[14px]">print</span>
                            Print Kitchen Ticket
                          </button>
                        </div>

                        <!-- Status changer -->
                        <div class="mt-4">
                          <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Update Status</p>
                          <div class="flex flex-wrap gap-2">
                            @for (s of allStatuses; track s) {
                              <button (click)="updateStatus(order, s); $event.stopPropagation()"
                                [disabled]="order.status === s || updatingStatusId() === order._id"
                                class="px-3 py-1.5 rounded-lg text-xs font-medium border transition-all"
                                [class]="order.status === s
                                  ? statusBadgeClass(s) + ' border-transparent cursor-default ring-2 ring-offset-1 ring-current'
                                  : 'border-gray-200 text-gray-500 hover:border-gray-400 hover:text-gray-700 disabled:opacity-40'">
                                {{ statusLabel(s) }}
                              </button>
                            }
                          </div>
                          @if (updatingStatusId() === order._id) {
                            <p class="text-xs text-gray-400 mt-2 flex items-center gap-1">
                              <span class="material-symbols-outlined text-[14px] animate-spin">progress_activity</span>
                              Updating…
                            </p>
                          }
                        </div>
                      </div>

                    </div>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    }
  </div>

</div>

<!-- Toast -->
@if (toast()) {
  <div class="fixed bottom-6 right-6 z-50 flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-sm font-medium"
    [class]="toast()!.type === 'success' ? 'bg-[#0a2e1a] text-white' : 'bg-red-600 text-white'">
    <span class="material-symbols-outlined text-[18px]">
      {{ toast()!.type === 'success' ? 'check_circle' : 'error' }}
    </span>
    {{ toast()!.message }}
  </div>
}
