<div class="flex flex-col h-full">

  <!-- Page Header -->
  <div class="flex items-center justify-between mb-6 flex-shrink-0">
    <div>
      <h1 class="text-2xl font-bold text-text-primary tracking-tight">Addons</h1>
      <p class="text-sm text-text-secondary mt-0.5">Modifier groups customers can select when ordering</p>
    </div>
    <button
      class="flex items-center gap-2 px-5 py-2.5 bg-primary hover:bg-primary-dark text-white text-sm font-semibold rounded-xl transition-colors shadow-sm cursor-pointer"
      (click)="openCreateForm()"
    >
      <span class="material-symbols-outlined text-[18px]">add</span>
      New Addon
    </button>
  </div>

  <!-- Content Grid -->
  <div class="flex gap-5 flex-1 min-h-0" [class.grid-with-form]="showCreateForm()">

    <!-- ── Create Form Panel ────────────────────────────────────────────── -->
    @if (showCreateForm()) {
      <div class="w-80 flex-shrink-0 flex flex-col bg-white rounded-2xl border border-gray-200/60 shadow-sm overflow-hidden">

        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100 flex-shrink-0">
          <h3 class="text-sm font-bold text-text-primary">Create Addon Group</h3>
          <button
            class="w-7 h-7 flex items-center justify-center rounded-lg text-text-secondary hover:bg-gray-100 hover:text-text-primary transition-colors cursor-pointer"
            (click)="cancelCreate()"
          >
            <span class="material-symbols-outlined text-[18px]">close</span>
          </button>
        </div>

        <div class="flex-1 overflow-y-auto p-5 flex flex-col gap-5">

          <!-- Name -->
          <div>
            <label class="text-xs font-semibold text-text-secondary uppercase tracking-wide block mb-1.5">
              Group Name <span class="text-error">*</span>
            </label>
            <input
              type="text"
              class="w-full rounded-lg border border-gray-200 px-3 py-2.5 text-sm placeholder:text-gray-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors"
              [(ngModel)]="createName"
              placeholder="e.g. Choice of Sauce"
            />
          </div>

          <!-- Selection Type -->
          <div>
            <label class="text-xs font-semibold text-text-secondary uppercase tracking-wide block mb-2">Selection Type</label>
            <div class="grid grid-cols-2 gap-2">
              <label
                class="flex flex-col items-center gap-1.5 py-3 px-2 rounded-xl border-[1.5px] cursor-pointer transition-all text-center"
                [class]="createType === 'single'
                  ? 'border-primary bg-primary-light text-primary'
                  : 'border-gray-200 text-text-secondary hover:border-gray-300'"
              >
                <input type="radio" name="createType" value="single" [(ngModel)]="createType" class="hidden" />
                <span class="material-symbols-outlined text-[20px]">radio_button_checked</span>
                <span class="text-xs font-semibold">Single</span>
                <span class="text-[10px] text-current/70">Customer picks one</span>
              </label>
              <label
                class="flex flex-col items-center gap-1.5 py-3 px-2 rounded-xl border-[1.5px] cursor-pointer transition-all text-center"
                [class]="createType === 'multiple'
                  ? 'border-primary bg-primary-light text-primary'
                  : 'border-gray-200 text-text-secondary hover:border-gray-300'"
              >
                <input type="radio" name="createType" value="multiple" [(ngModel)]="createType" class="hidden" />
                <span class="material-symbols-outlined text-[20px]">check_box</span>
                <span class="text-xs font-semibold">Multiple</span>
                <span class="text-[10px] text-current/70">Customer picks many</span>
              </label>
            </div>
          </div>

          <!-- Options -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-xs font-semibold text-text-secondary uppercase tracking-wide">
                Options <span class="text-error">*</span>
              </label>
              <button
                class="flex items-center gap-1 text-xs font-semibold text-primary hover:text-primary-dark transition-colors cursor-pointer"
                type="button"
                (click)="addCreateOption()"
              >
                <span class="material-symbols-outlined text-[14px]">add</span>
                Add
              </button>
            </div>
            <div class="flex flex-col gap-2">
              @for (option of createOptions; track $index) {
                <div class="flex items-center gap-2">
                  <input
                    type="text"
                    class="flex-1 rounded-lg border border-gray-200 px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors"
                    [(ngModel)]="option.name"
                    placeholder="Option name"
                  />
                  <div class="relative flex-shrink-0 w-20">
                    <span class="absolute left-2.5 top-1/2 -translate-y-1/2 text-xs text-gray-400 font-medium">₹</span>
                    <input
                      type="number"
                      class="w-full rounded-lg border border-gray-200 pl-7 pr-2 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors"
                      [(ngModel)]="option.price"
                      placeholder="0"
                      min="0"
                    />
                  </div>
                  <button
                    class="w-7 h-7 flex items-center justify-center rounded-lg text-gray-400 hover:bg-error/10 hover:text-error transition-colors cursor-pointer disabled:opacity-30 disabled:cursor-not-allowed"
                    type="button"
                    (click)="removeCreateOption($index)"
                    [disabled]="createOptions.length <= 1"
                  >
                    <span class="material-symbols-outlined text-[16px]">delete</span>
                  </button>
                </div>
              }
            </div>
          </div>

        </div>

        <div class="flex items-center gap-2 px-5 py-4 border-t border-gray-100 flex-shrink-0">
          <button
            class="flex items-center gap-2 px-4 py-2 bg-primary hover:bg-primary-dark text-white text-sm font-semibold rounded-xl transition-colors cursor-pointer"
            (click)="submitCreate()"
          >
            <span class="material-symbols-outlined text-[16px]">check</span>
            Create
          </button>
          <button
            class="px-4 py-2 text-sm font-medium text-text-secondary border border-gray-200 rounded-xl hover:bg-gray-50 transition-colors cursor-pointer"
            (click)="cancelCreate()"
          >
            Cancel
          </button>
        </div>

      </div>
    }

    <!-- ── Addons Table Panel ────────────────────────────────────────────── -->
    <div class="flex-1 min-w-0 flex flex-col bg-white rounded-2xl border border-gray-200/60 shadow-sm overflow-hidden">

      <!-- Toolbar -->
      <div class="flex items-center justify-between px-5 py-3.5 border-b border-gray-100 flex-shrink-0 gap-3">
        <div class="flex items-center gap-3 flex-1 min-w-0">
          <!-- Search -->
          <div class="relative flex-1 max-w-xs">
            <span class="material-symbols-outlined absolute left-2.5 top-1/2 -translate-y-1/2 text-[16px] text-gray-400">search</span>
            <input
              type="text"
              class="w-full pl-8 pr-3 py-2 text-sm rounded-lg border border-gray-200 placeholder:text-gray-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors"
              placeholder="Search addons or options..."
              [ngModel]="searchQuery()"
              (ngModelChange)="searchQuery.set($event)"
            />
          </div>
          <!-- Filter -->
          <select
            class="rounded-lg border border-gray-200 px-3 py-2 text-sm text-text-primary focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors bg-white cursor-pointer"
            [ngModel]="filterType()"
            (ngModelChange)="filterType.set($event)"
          >
            <option value="">All types</option>
            <option value="single">Single select</option>
            <option value="multiple">Multi-select</option>
          </select>
        </div>
        <span class="text-xs text-text-secondary font-medium flex-shrink-0">
          {{ filteredAddons().length }} group{{ filteredAddons().length !== 1 ? 's' : '' }}
        </span>
      </div>

      <!-- Table -->
      <div class="flex-1 overflow-auto">
        <table class="w-full">
          <thead>
            <tr class="border-b border-gray-100">
              <th class="text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3">Addon Group</th>
              <th class="text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-4 py-3 w-28">Type</th>
              <th class="text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-4 py-3">Options</th>
              <th class="text-left text-xs font-semibold text-text-secondary uppercase tracking-wider px-4 py-3 w-28">Status</th>
              <th class="text-right text-xs font-semibold text-text-secondary uppercase tracking-wider px-5 py-3 w-24">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (addon of filteredAddons(); track addon._id) {

              <!-- Normal Row -->
              @if (editingAddonId() !== addon._id) {
                <tr
                  class="border-b border-gray-50 transition-colors hover:bg-gray-50/60"
                  [class.opacity-50]="!addon.isActive"
                >
                  <td class="px-5 py-3.5">
                    <span class="text-sm font-semibold text-text-primary">{{ addon.name }}</span>
                  </td>
                  <td class="px-4 py-3.5">
                    <span
                      class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold"
                      [class]="addon.type === 'multiple'
                        ? 'bg-violet-50 text-violet-600'
                        : 'bg-primary-light text-primary'"
                    >
                      <span class="material-symbols-outlined text-[12px]">
                        {{ addon.type === 'single' ? 'radio_button_checked' : 'check_box' }}
                      </span>
                      {{ addon.type === 'single' ? 'Single' : 'Multi' }}
                    </span>
                  </td>
                  <td class="px-4 py-3.5">
                    <div class="flex flex-wrap gap-1.5">
                      @for (opt of addon.options.slice(0, 3); track opt._id) {
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-xs text-text-secondary font-medium">
                          {{ opt.name }}
                          @if (opt.price > 0) {
                            <span class="ml-1 text-primary">+₹{{ opt.price }}</span>
                          }
                        </span>
                      }
                      @if (addon.options.length > 3) {
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-xs text-text-secondary font-medium">
                          +{{ addon.options.length - 3 }} more
                        </span>
                      }
                    </div>
                  </td>
                  <td class="px-4 py-3.5">
                    <button
                      class="flex items-center gap-2 text-xs font-semibold transition-colors cursor-pointer"
                      [class]="addon.isActive ? 'text-primary' : 'text-gray-400'"
                      (click)="toggleActive(addon._id)"
                    >
                      <span
                        class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors duration-200"
                        [class]="addon.isActive ? 'bg-primary' : 'bg-gray-200'"
                      >
                        <span
                          class="inline-block h-3.5 w-3.5 rounded-full bg-white shadow transition-transform duration-200"
                          [class]="addon.isActive ? 'translate-x-4' : 'translate-x-1'"
                        ></span>
                      </span>
                      {{ addon.isActive ? 'Active' : 'Off' }}
                    </button>
                  </td>
                  <td class="px-5 py-3.5">
                    <div class="flex items-center justify-end gap-1">
                      <button
                        class="w-8 h-8 flex items-center justify-center rounded-lg text-text-secondary hover:bg-primary-light hover:text-primary transition-colors cursor-pointer"
                        (click)="startEdit(addon)"
                        title="Edit"
                      >
                        <span class="material-symbols-outlined text-[16px]">edit</span>
                      </button>
                      <button
                        class="w-8 h-8 flex items-center justify-center rounded-lg text-text-secondary hover:bg-error/10 hover:text-error transition-colors cursor-pointer"
                        (click)="confirmDelete(addon._id)"
                        title="Delete"
                      >
                        <span class="material-symbols-outlined text-[16px]">delete</span>
                      </button>
                    </div>
                  </td>
                </tr>
              }

              <!-- Inline Edit Row -->
              @if (editingAddonId() === addon._id) {
                <tr class="border-b border-primary/20 bg-primary-light/40">
                  <td colspan="5" class="px-5 py-4">
                    <div class="flex flex-col gap-4">

                      <!-- Top: Name + Type -->
                      <div class="flex items-start gap-6">
                        <div class="flex-1 max-w-xs">
                          <label class="text-xs font-semibold text-text-secondary uppercase tracking-wide block mb-1.5">Group Name</label>
                          <input
                            type="text"
                            class="w-full rounded-lg border border-gray-200 px-3 py-2 text-sm placeholder:text-gray-400 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors bg-white"
                            [(ngModel)]="editName"
                            placeholder="Addon group name"
                          />
                        </div>
                        <div>
                          <label class="text-xs font-semibold text-text-secondary uppercase tracking-wide block mb-1.5">Type</label>
                          <div class="flex gap-2">
                            <label
                              class="flex items-center gap-1.5 px-3 py-2 rounded-lg border-[1.5px] text-xs font-semibold cursor-pointer transition-all"
                              [class]="editType === 'single' ? 'border-primary bg-primary-light text-primary' : 'border-gray-200 text-text-secondary bg-white hover:border-gray-300'"
                            >
                              <input type="radio" name="editType" value="single" [(ngModel)]="editType" class="hidden" />
                              Single
                            </label>
                            <label
                              class="flex items-center gap-1.5 px-3 py-2 rounded-lg border-[1.5px] text-xs font-semibold cursor-pointer transition-all"
                              [class]="editType === 'multiple' ? 'border-primary bg-primary-light text-primary' : 'border-gray-200 text-text-secondary bg-white hover:border-gray-300'"
                            >
                              <input type="radio" name="editType" value="multiple" [(ngModel)]="editType" class="hidden" />
                              Multiple
                            </label>
                          </div>
                        </div>
                      </div>

                      <!-- Options -->
                      <div>
                        <div class="flex items-center justify-between mb-2">
                          <label class="text-xs font-semibold text-text-secondary uppercase tracking-wide">Options</label>
                          <button
                            class="flex items-center gap-1 text-xs font-semibold text-primary hover:text-primary-dark transition-colors cursor-pointer"
                            type="button"
                            (click)="addEditOption()"
                          >
                            <span class="material-symbols-outlined text-[14px]">add</span>
                            Add option
                          </button>
                        </div>
                        <div class="flex flex-wrap gap-2">
                          @for (option of editOptions; track option.id) {
                            <div class="flex items-center gap-1.5 bg-white rounded-lg border border-gray-200 p-1.5">
                              <input
                                type="text"
                                class="w-28 rounded border-0 px-2 py-1 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/20 rounded-md"
                                [(ngModel)]="option.name"
                                placeholder="Option name"
                              />
                              <div class="relative w-16">
                                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs text-gray-400">₹</span>
                                <input
                                  type="number"
                                  class="w-full rounded border-0 pl-5 pr-1 py-1 text-sm placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-primary/20 rounded-md"
                                  [(ngModel)]="option.price"
                                  placeholder="0"
                                  min="0"
                                />
                              </div>
                              <button
                                class="w-6 h-6 flex items-center justify-center text-gray-400 hover:text-error transition-colors cursor-pointer disabled:opacity-30 disabled:cursor-not-allowed"
                                type="button"
                                (click)="removeEditOption($index)"
                                [disabled]="editOptions.length <= 1"
                              >
                                <span class="material-symbols-outlined text-[14px]">close</span>
                              </button>
                            </div>
                          }
                        </div>
                      </div>

                      <!-- Actions -->
                      <div class="flex items-center gap-2">
                        <button
                          class="flex items-center gap-1.5 px-4 py-2 bg-primary hover:bg-primary-dark text-white text-xs font-semibold rounded-xl transition-colors cursor-pointer"
                          (click)="submitEdit(addon._id)"
                        >
                          <span class="material-symbols-outlined text-[14px]">check</span>
                          Save changes
                        </button>
                        <button
                          class="px-4 py-2 text-xs font-medium text-text-secondary border border-gray-200 rounded-xl hover:bg-white transition-colors cursor-pointer"
                          (click)="cancelEdit()"
                        >
                          Cancel
                        </button>
                      </div>

                    </div>
                  </td>
                </tr>
              }

              <!-- Delete Confirm Row -->
              @if (deleteConfirmId() === addon._id) {
                <tr class="border-b border-error/20 bg-error/5">
                  <td colspan="5" class="px-5 py-3.5">
                    <div class="flex items-center gap-4">
                      <span class="material-symbols-outlined text-[20px] text-error flex-shrink-0">warning</span>
                      <span class="text-sm text-text-primary flex-1">
                        Delete <strong>{{ addon.name }}</strong>? Products using this addon will lose this option.
                      </span>
                      <div class="flex items-center gap-2 flex-shrink-0">
                        <button
                          class="px-4 py-1.5 bg-error hover:bg-red-600 text-white text-xs font-semibold rounded-lg transition-colors cursor-pointer"
                          (click)="submitDelete(addon._id)"
                        >
                          Delete
                        </button>
                        <button
                          class="px-4 py-1.5 text-xs font-medium text-text-secondary border border-gray-200 rounded-lg hover:bg-white transition-colors cursor-pointer"
                          (click)="cancelDelete()"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </td>
                </tr>
              }
            }

            @if (filteredAddons().length === 0) {
              <tr>
                <td colspan="5" class="py-16 text-center">
                  <span class="material-symbols-outlined text-[40px] text-gray-200 block mb-3">add_circle</span>
                  <p class="text-sm text-text-secondary font-medium">No addons found</p>
                  <button
                    class="mt-3 text-xs font-semibold text-primary hover:text-primary-dark cursor-pointer"
                    (click)="openCreateForm()"
                  >
                    Create one
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Table Footer -->
      <div class="px-5 py-3 border-t border-gray-100 flex-shrink-0">
        <span class="text-xs text-text-secondary">Showing {{ filteredAddons().length }} of {{ addons().length }} addon groups</span>
      </div>

    </div>
  </div>

</div>

<!-- Toast -->
@if (toast()) {
  <div class="fixed bottom-6 right-6 flex items-center gap-3 px-5 py-3.5 bg-[#111814] text-white text-sm font-medium rounded-xl shadow-2xl z-[1000] animate-slide-up">
    <span
      class="material-symbols-outlined text-[18px]"
      [class]="toast()!.type === 'success' ? 'text-primary' : 'text-error'"
    >
      {{ toast()!.type === 'success' ? 'check_circle' : 'error' }}
    </span>
    {{ toast()!.message }}
  </div>
}
