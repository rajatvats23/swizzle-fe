<!-- Staff Management -->
<div class="flex flex-col flex-1 min-h-0">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6 flex-shrink-0">
    <div>
      <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Staff Management</h1>
      <p class="text-gray-500 text-sm mt-1">Manage your restaurant team and roles</p>
    </div>
    <button
      (click)="openCreateModal()"
      class="flex items-center gap-2 px-5 py-2.5 bg-primary text-white font-bold rounded-xl hover:bg-primary/90 transition-colors shadow-sm shadow-primary/20 cursor-pointer"
    >
      <span class="material-symbols-outlined text-xl">person_add</span>
      Add Staff
    </button>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 flex-shrink-0">
    <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-3">
      <div class="w-11 h-11 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center">
        <span class="material-symbols-outlined text-xl">groups</span>
      </div>
      <div>
        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Total</p>
        <p class="text-xl font-bold">{{ stats().total }}</p>
      </div>
    </div>
    <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-3">
      <div class="w-11 h-11 rounded-xl bg-primary/10 text-primary flex items-center justify-center">
        <span class="material-symbols-outlined text-xl">check_circle</span>
      </div>
      <div>
        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Active</p>
        <p class="text-xl font-bold">{{ stats().active }}</p>
      </div>
    </div>
    <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-3">
      <div class="w-11 h-11 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center">
        <span class="material-symbols-outlined text-xl">block</span>
      </div>
      <div>
        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Inactive</p>
        <p class="text-xl font-bold">{{ stats().inactive }}</p>
      </div>
    </div>
    <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-center gap-3">
      <div class="w-11 h-11 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center">
        <span class="material-symbols-outlined text-xl">badge</span>
      </div>
      <div>
        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Roles</p>
        <p class="text-xl font-bold">{{ roles.length }}</p>
      </div>
    </div>
  </div>

  <!-- Filters + Search -->
  <div class="bg-white rounded-t-xl border border-gray-200 border-b-0 p-4 flex-shrink-0">
    <div class="flex flex-col md:flex-row gap-4 justify-between">
      <div class="flex flex-wrap gap-2">
        @for (f of roleFilters; track f.key) {
          <button
            (click)="activeRoleFilter.set(f.key)"
            class="px-4 py-2 rounded-xl text-sm font-semibold transition-all cursor-pointer"
            [class]="activeRoleFilter() === f.key
              ? 'bg-primary text-white'
              : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
          >
            {{ f.label }}
          </button>
        }
      </div>
      <div class="relative">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-lg">search</span>
        <input
          type="text"
          [ngModel]="searchQuery()"
          (ngModelChange)="searchQuery.set($event)"
          placeholder="Search staff..."
          class="pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none w-56"
        />
      </div>
    </div>
  </div>

  <!-- Staff Table -->
  <div class="bg-white rounded-b-xl border border-gray-200 overflow-x-auto flex-1 min-h-0">
    @if (loading()) {
      <div class="flex items-center justify-center h-48">
        <span class="w-8 h-8 border-2 border-primary/20 border-t-primary rounded-full animate-spin"></span>
      </div>
    } @else if (filteredStaff().length === 0) {
      <div class="flex flex-col items-center justify-center h-48 text-gray-400">
        <span class="material-symbols-outlined text-4xl mb-2">person_off</span>
        <p class="text-sm font-medium">No staff found</p>
      </div>
    } @else {
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-gray-50 border-b border-gray-200">
            <th class="px-6 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wider">Staff Member</th>
            <th class="px-6 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wider">Role</th>
            <th class="px-6 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wider">Contact</th>
            <th class="px-6 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wider">2FA</th>
            <th class="px-6 py-3.5 text-xs font-bold text-gray-500 uppercase tracking-wider text-right">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          @for (s of filteredStaff(); track s._id) {
            <tr class="hover:bg-gray-50/50 transition-colors">
              <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                  <div
                    class="w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold flex-shrink-0"
                    [class]="s.isActive !== false ? 'bg-primary/10 text-primary' : 'bg-gray-100 text-gray-400'"
                  >
                    {{ getInitials(s.name) }}
                  </div>
                  <div>
                    <p class="font-bold text-gray-900">{{ s.name }}</p>
                    <p class="text-xs text-gray-500">{{ s.email }}</p>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4">
                <span
                  class="px-2.5 py-1 rounded-full text-xs font-bold capitalize"
                  [class]="getRoleBadgeClass(s.role)"
                >
                  {{ s.role }}
                </span>
              </td>
              <td class="px-6 py-4">
                <p class="text-sm text-gray-700">{{ s.phone || 'â€”' }}</p>
              </td>
              <td class="px-6 py-4">
                <div class="flex items-center gap-1.5">
                  <span
                    class="w-2 h-2 rounded-full"
                    [class]="s.isActive !== false ? 'bg-primary' : 'bg-gray-300'"
                  ></span>
                  <span class="text-sm font-medium text-gray-700">
                    {{ s.isActive !== false ? 'Active' : 'Inactive' }}
                  </span>
                </div>
              </td>

              <!-- 2FA toggle -->
              <td class="px-6 py-4">
                <div class="flex items-center gap-2">
                  <button
                    type="button"
                    (click)="toggleMfa(s)"
                    title="{{ s.mfaRequired ? 'Disable 2FA' : 'Enable 2FA' }}"
                    class="relative inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full transition-colors duration-200 focus:outline-none"
                    [class]="s.mfaRequired ? 'bg-primary' : 'bg-gray-200'"
                  >
                    <span
                      class="inline-block h-3.5 w-3.5 transform rounded-full bg-white shadow transition-transform duration-200"
                      [class]="s.mfaRequired ? 'translate-x-4.5' : 'translate-x-0.5'"
                    ></span>
                  </button>
                  @if (s.mfaRequired) {
                    <span
                      class="text-xs font-semibold"
                      [class]="s.mfaEnabled ? 'text-primary' : 'text-amber-500'"
                      [title]="s.mfaEnabled ? 'Enrolled' : 'Pending setup on next login'"
                    >
                      {{ s.mfaEnabled ? 'Enrolled' : 'Pending' }}
                    </span>
                  }
                </div>
              </td>

              <td class="px-6 py-4 text-right">
                <button
                  (click)="openEditModal(s)"
                  class="p-1.5 text-gray-400 hover:text-primary transition-colors cursor-pointer"
                  title="Edit"
                >
                  <span class="material-symbols-outlined text-xl">edit</span>
                </button>
                <button
                  (click)="toggleActive(s)"
                  class="p-1.5 text-gray-400 hover:text-gray-600 transition-colors cursor-pointer"
                  [title]="s.isActive !== false ? 'Deactivate' : 'Activate'"
                >
                  <span class="material-symbols-outlined text-xl">
                    {{ s.isActive !== false ? 'person_off' : 'person' }}
                  </span>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>
</div>

<!-- Create/Edit Modal -->
@if (showModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-black/40" (click)="closeModal()"></div>
    <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 z-10">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold text-gray-900">
          {{ editingStaff() ? 'Edit Staff' : 'Add New Staff' }}
        </h3>
        <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600 cursor-pointer">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <form (ngSubmit)="saveStaff()" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Name</label>
          <input
            type="text"
            [ngModel]="formName()"
            (ngModelChange)="formName.set($event)"
            name="name"
            placeholder="Full name"
            class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
            required
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Email</label>
          <input
            type="email"
            [ngModel]="formEmail()"
            (ngModelChange)="formEmail.set($event)"
            name="email"
            placeholder="name&#64;swizzle.com"
            class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
            [class]="editingStaff() ? 'bg-gray-50 cursor-not-allowed' : ''"
            [readonly]="!!editingStaff()"
            required
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">
            {{ editingStaff() ? 'New Password (leave blank to keep current)' : 'Password' }}
          </label>
          <input
            type="password"
            [ngModel]="formPassword()"
            (ngModelChange)="formPassword.set($event)"
            name="password"
            placeholder="Enter password"
            class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
            [required]="!editingStaff()"
          />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Role</label>
          <select
            [ngModel]="formRole()"
            (ngModelChange)="formRole.set($event)"
            name="role"
            class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none bg-white cursor-pointer"
          >
            @for (r of roles; track r) {
              <option [value]="r">{{ r | titlecase }}</option>
            }
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">Phone</label>
          <input
            type="tel"
            [ngModel]="formPhone()"
            (ngModelChange)="formPhone.set($event)"
            name="phone"
            placeholder="Phone number (optional)"
            class="w-full px-4 py-2.5 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none"
          />
        </div>

        <div class="flex gap-3 pt-2">
          <button
            type="button"
            (click)="closeModal()"
            class="flex-1 py-2.5 border border-gray-200 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-colors cursor-pointer"
          >
            Cancel
          </button>
          <button
            type="submit"
            [disabled]="formSaving()"
            class="flex-1 py-2.5 bg-primary text-white rounded-xl text-sm font-bold hover:bg-primary/90 transition-colors disabled:opacity-50 cursor-pointer"
          >
            {{ formSaving() ? 'Saving...' : (editingStaff() ? 'Update' : 'Create') }}
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Toast -->
@if (toast()) {
  <div
    class="fixed bottom-6 right-6 z-50 flex items-center gap-2 px-4 py-3 rounded-xl shadow-xl text-white text-sm font-medium"
    [class]="toast()!.type === 'success' ? 'bg-gray-900' : 'bg-red-600'"
  >
    <span class="material-symbols-outlined text-lg">
      {{ toast()!.type === 'success' ? 'check_circle' : 'error' }}
    </span>
    {{ toast()!.message }}
  </div>
}
